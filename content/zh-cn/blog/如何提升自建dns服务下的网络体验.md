---
layout: blog
title: 如何提升自建DNS服务下的网络体验
published: true
categories: 网络
tags: [网络, blog]
date: 2024-05-18 10:46:44 +0800
draft: false
toc: false
comments: false
---

## 网络质量和网络体验

> 什么都不做, 即可以获得最好的网络体验

需要明确, 这里`网络质量`和`网络体验`是两个不同的概念. 通信是一个过程, 涉及多个设备, 我们可以称单个设备的上下行表现为`网络质量`, 而整个端到端的通信表现, 我们可以称为`网络体验`.

## 如何衡量网络质量

衡量网络质量通常涉及多个指标和方法。以下是一些常见的衡量网络质量的方法和指标：

1. **带宽（Bandwidth）**：带宽是指网络传输数据的能力，通常以每秒传输的数据量（比特/秒）来衡量。更高的带宽通常表示更好的网络质量。
2. **延迟（Latency）**：延迟是指数据从发送端到接收端所需的时间。低延迟表示数据传输速度快，网络响应更快。
3. **丢包率（Packet Loss Rate）**：丢包率是指在数据传输过程中丢失的数据包的比例。较低的丢包率通常意味着网络质量较好。
4. **抖动（Jitter）**：抖动是指数据包在传输过程中的变化或波动。较小的抖动表示网络稳定性较高。
5. **吞吐量（Throughput）**：吞吐量是指网络传输的实际数据量，通常以单位时间内的数据传输量来衡量。更高的吞吐量表示网络质量更好。
6. **网络拓扑（Network Topology）**：网络拓扑描述了网络中节点之间的连接方式和结构。合理的网络拓扑设计可以提高网络性能和质量。
7. **服务质量（Quality of Service，QoS）**：QoS 是一组技术和机制，用于确保在网络中的数据传输中实现可接受的服务质量。QoS 可以通过各种方式实现，包括流量控制、优先级队列等。
8. **网络协议分析（Protocol Analysis）**：通过分析网络协议和数据包，可以了解网络中的性能指标和问题，例如使用 Wireshark 等网络分析工具。

综合利用这些指标和方法，可以全面地评估网络质量，确定网络性能的优势和改进的空间。 但这些是运营商关注的指标, 对于普通用户, 只需要购买价格合适的路由器即可, 现代路由器都有自动调整网络质量的功能.

## 如何衡量网络体验

首先是**可访问性**, 能访问是最重要的基础. 因此, 域名解析服务需要满足基础的能力:

- 全面, 上级 DNS 服务需要权威, 且能够解析更多的域名
- 正确, 解析结果需要正确, 不能出现解析错误. 部分 DNS 服务商会对一些域名进行劫持或污染, 解析到广告页面.
- 及时, ip 地址变更后, 需要及时更新解析结果, 而不是返回旧的 ip 地址

其次是 DNS 解析结果的 IP 所能提供服务的`网络质量`.

互联网服务所能提供的`网络质量`, 通常**强依赖地域**, 服务器和客户端在地域上越接近, 则服务质量越好.

许多付费 DNS 解析服务商都支持按地域解析不同 IP, 例如这是阿里云能提供的一部分服务:

> （1）运营商线路：支持按联通、电信、移动、教育网、鹏博士、广电网智能解析，细分到省份；  
> （2）海外地区线路：支持，细分到大洲、国家；  
> （3）阿里云线路：支持，细分到各个地区；  
> （4）自定义线路：支持自定义 IP 地址范围智能解析；

![](https://jqknono-image.oss-cn-hangzhou.aliyuncs.com/blog/20240518153221.png)

按区域解析不同 IP 的机制, 意味着不同地域的用户访问同一个域名时, 会得到不同的解析结果, 自然而然的, 优先解析到距离用户更近的服务器, 将会有更好的网络体验.

而优化用户网络体验这件事, 一般都是服务提供商根据用户的真实 IP 地址来做优化. 也就是对多数用户来说, `什么都不做, 即可以获得最好的网络体验`.

## 自建 DNS 服务如何选择上游 DNS 服务

中文互联网你搜索到的所有资料都会推荐你选择权威 DNS 服务商, 例如阿里云, 腾讯云, Cloudflare, 谷歌等. 这些 DNS 可以满足网络服务的的`可访问性`, 因为它们全面/正确/及时, 但是, 它们未必会给你解析到最近的服务器 IP.

互联网上大量的资料推荐大企业的 DNS 服务有其历史原因.

曾经我国的 ISP 运营商, 仅靠 DNS 劫持加上 HTTP 的中间人攻击, 就能够实现对用户的流量劫持, 从而实现广告推送. 现如今随着 https 的普及, 这种劫持方式已较为少见, 但部分地区的小区宽带仍然可能存在这种问题. 针对 DNS 劫持问题, 实际上改 DNS IP 无济于事, 因为劫持可以针对 53 端口, 而绝大多数 DNS 请求都是未加密的.

此外, 一些特殊用户希望访问特殊网站, 而部分 DNS 服务商存在 IP 污染问题, 会将特殊网站的域名解析到错误的 IP 地址, 导致无法访问. 而权威 DNS 服务商则较少出现这样问题.

因此, 这里存在三个问题需要考虑:

1. IP 污染
1. DNS 劫持
1. 最优服务体验

权威 DNS 服务商可以解决问题 1 , 加密协议(DoT/DoH/QUIC)可以解决问题 2.

**想要解决问题 3, 你需要使用回宽带运营商的默认 DNS 服务.**, 正如本文开头所说, `什么都不做, 即可以获得最好的网络体验`.

但如果你是一个有追求的人, 或者特殊用户, 下文将介绍如何配置 `AdguardHome` 及 `Clash` 两种工具的配置, 以同时解决这三个问题.

## 权威且智能的 DNS 服务

### AdguardHome 配置

[AdguardHome](https://github.com/AdguardTeam/AdGuardHome), 以下简称`ADG` 是一个网络广告拦截与隐私保护软件, 也是一个 DNS 服务. 它支持自定义上游 DNS 服务, 以及自定义 DNS 规则.

`ADG` 默认的向上游请求 DNS 的方式是`负载均衡`, 用户可以设置多个上游, `ADG`将根据历史 DNS 查询加权权重选择其中 DNS 响应最快的上游. 简单说, `ADG` 会以更高的概率选择更快的 DNS 上游来解析域名, 以较低的概率选择非最优的 DNS 上游.

我们可以选择第三个选项: `最快的IP地址`.

![](https://jqknono-image.oss-cn-hangzhou.aliyuncs.com/blog/20240518214956.png)

该选项带来的好处, `ADG`自行测试上游 DNS 的 IP 解析结果, 将其中延迟最低的 IP 返回给下游客户端. 以下是**bilibili**的常规解析结果.

![](https://jqknono-image.oss-cn-hangzhou.aliyuncs.com/blog/20240518215036.png)

你可以看到 IP 非常多, 如果`ADG`不测试 IP 解析结果, 而将所有 IP 返回给客户端, 那么客户端会做什么?

有的客户端会选择第一个 IP, 有的客户端会选择最后一个 IP, 有的客户端会随机选择一个 IP. 不管是哪种, 都未必是最优的选择.

开启`最快的IP地址`选项后, 以下是**bilibili**的优选解析结果, **这一步将会带来`网络体验`的提升**.

![](https://jqknono-image.oss-cn-hangzhou.aliyuncs.com/blog/20240518215112.png)

**`最快的IP地址`为什么不是默认选择? 这个功能这么实用, 为什么不默认开启?**

因为它的代价是*等待所有上游 DNS 的 IP 解析结果*, 当你的上游同时有多个 DNS 服务商时, 向上游的查询时间以其中最慢的为准. 例如, 你的上游有平均服务时长`50ms`的阿里和平均服务时长`500ms`谷歌, `ADG`的上游查询时间将是`500ms+`.

因此用户在配置此选项时, 需要权衡上游 DNS 的服务质量和数量, 不要贪多.  
这里我推荐设置两个上游, **一个权威(https://dns.alidns.com/dns-query)**, 加上**一个运营商 DNS**.

运营商的 DNS IP 各地都不相同, 可以点击[这里](https://ipw.cn/doc/else/dns.html)查看自己所在地区的运营商 DNS.

或者, 你可以在路由器的管理界面上查看运营商推荐的 DNS :

![](https://jqknono-image.oss-cn-hangzhou.aliyuncs.com/blog/20240518225645.png)

### Clash 配置

特殊需求用户看重 DNS 劫持和 IP 污染问题, 但又不想放弃最优服务体验, 可以使用`Clash`的`dns`模块.

其中`nameserver-policy`可以指定不同的域名使用不同的 DNS 服务商, 以下是一个示例配置:

```yaml
dns:
  default-nameserver:
    - tls://223.5.5.5:853
    - tls://1.12.12.12:853
  nameserver:
    - https://dns.alidns.com/dns-query
    - https://one.one.one.one/dns-query
    - https://dns.google/dns-query
  nameserver-policy:
    "geosite:cn,private,apple":
      - 202.103.24.68 # 自己所在地的运营商 DNS
      - https://dns.alidns.com/dns-query
    "geosite:geolocation-!cn":
      - https://one.one.one.one/dns-query
      - https://dns.google/dns-query
```

它的含义是:

- default-nameserver: 用于解析配置`nameserver`中的 DNS 服务的 IP
- nameserver: 用于解析网络请求的域名
- nameserver-policy: 根据策略, 指定不同的域名使用不同的 DNS 服务

## 感谢阅读

如果本文对您有所帮助, 还请点个赞. 也非常欢迎留言讨论.
