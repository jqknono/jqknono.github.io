---
layout: blog
title: 建议国内自建站点都做备案
description:
published: true
categories: 网络
tags: [网络, blog]
date: 2024-06-03 18:06:54 +0800
draft: true
toc: true
toc_hide: false
math: false
comments: false
giscus_comments: true
hide_summary: false
hide_feedback: false
---

<!-- ## 引言

我知道人人都生性放荡不羁爱自由, 但是网络上浑人太多, 弄得网络乌烟瘴气, 暂且表达对网络管控严格的理解.

但是还有很多人自己搭建网络, 无非为了利用开源软件搭建一些自用服务而已, 或者像我这样只写点技术博客, 同样也会被这种严格政策误伤.

在较长的时间里我都抗拒备案, 到目前也觉得非常麻烦, 但仍然不情不愿的推荐大家做一下备案, 下边是基于技术角度的分析备案拦截技术实现. -->

## 术语

读者需要先知晓以下概念:

- **公有云服务商**: 将硬件资源抽象后, 以虚拟化资源售卖, 使用者不必接触硬件.
- **服务器**: 公有云提供的处理器/存储/网络等资源的组合, 类似个人使用的电脑手机等.
- **IP**: 一串数字, 用来设备间通信寻址
- **域名**: 用来代替 IP, 人类更容易记忆
- **http**: 一种网络协议, 用来传输网页等资源
- **https**: http 的加密版本
- **反向代理**: 代理服务器, 实现根据域名转发请求到不同的服务

## 不备案会怎样

实际上不备案也可以访问自己搭建的服务, 目前仅能通过 IP 访问.

曾经仅封禁了 80 端口, 我们还可以通过**域名:8080**这样的组合访问自己的服务, 但在**2024.06**这个时间点, 所有 http 服务不分端口, 已全都被拦截, 重定向到各公有云服务商的提示页面.

![](https://s2.loli.net/2024/06/03/oOrA4JGnkdQMRSD.png)

如果你有两个域名, 一个备过案, 一个未备案, 同时指向同一台服务器, 可以看到只有未备案的域名访问时会重定向到提示页面. 这说明服务商对流量进行了采集分析, 域名在报文中是未加密的, 很容易解析出来核对.

https 流量是加密的, 为何也会被识别拦截?

https 的四次握手特征明显:

1. 客户端发起连接：客户端（如浏览器）向服务器发起 HTTPS 连接请求。
1. 服务器响应：服务器回应并发送数字证书给客户端，证书中包含服务器的公钥和由可信任的证书颁发机构（CA）签名的信息。
1. 验证证书：客户端验证服务器的数字证书，确保其有效且可信。
1. 生成会话密钥：客户端生成一个随机的对称会话密钥，并使用服务器的公钥加密这个密钥，然后发送给服务器。
1. 建立安全连接：服务器使用自己的私钥解密会话密钥。从此刻起，客户端和服务器将使用这个对称密钥进行加密通信。

在建立连接时会暴露域名, 服务商只要干扰加密连接的建立即可以实行拦截, 服务商可以通过头部字段解析出域名, 进而判断是否备案. 如果未备案, https 的拦截表现和 http 的不同, 它并没有重定向, 毕竟有证书校验, 服务商会直接断开连接, 最终仍然无法正常访问. 常见的报错有:

- `ERR_SSL_UNRECOGNIZED_NAME_ALERT`
- `Connection reset by peer`
- `failed to receive handshake, SSL/TLS connection failed.`
- `An existing connection was forcibly closed by the remote host.`

基于以上过程, 我们可以知道绝大多数未备案的服务都是无法通过备案检查的, 除非该服务不使用 http 协议, 比如 DoT(DNS over TLS)就可以绕过备案检查, 我自建的 DoT 安卓广告拦截服务`tls://dns.jqknono.com`未备过案但可以一直免费提供给网友使用.

http 协议是最常用的, 实现所有自建服务都绕过 http 协议基本不可能.

## 只使用 ip 访问会有什么问题

一般认为最直接的影响是 IP 不便记忆, 如果用户多年使用一个 IP, 记忆并没有难度. **不便**不是使用 IP 搭建服务的核心问题.

1. 对个人来说最核心的问题是**证书**.

为什么证书是必须的? 各主流浏览器在本文写作时, 已实现默认自动跳转 https, 未加密的网站已没有生存空间, 每个用户和开发者都需要将证书加密的安全保障作为一项基础服务.

收费的证书价格不菲, 但是免费证书也有很多, 最常见的免费证书是 Let's Encrypt, 它的证书是基于域名的, 无法通过 IP 申请, 也就是说, 使用 IP 搭建服务, 无法使用 Let's Encrypt 证书.

当然, 也有免费的 IP 证书服务, [ZeroSSL](https://zerossl.com/)就是一个免费的 IP 证书服务, 但是它只能申请 3 个证书, 付费服务同样不便宜.

有一些服务明确的依赖证书和域名验证, 如**nextcloud**, **headscale**, **tojan**等, 跳过证书验证将失去安全保障.

在申请 Let's Encrypt 证书时, 会要求验证域名所有权, 通过域名验证证明你对域名的控制权, 证书的有效期是 90 天, 证书过期后需要重新验证, 证书的自动续期需要域名的持续控制权, 通过 IP 无法验证域名所有权, 也就无法实现证书的自动续期. ZeroSSL 可能验证逻辑不同, 可能是验证服务器的所有权, 因此它限制的是证书数量, 避免滥用.

我们主要关注 Let's Encrypt 证书的验证, 域名验证有两种方式:

- **HTTP-01**: 通过在域名下放置一个特定的文件来验证域名所有权. 通过域名访问该文件, 证明你对域名的控制权.
- **DNS-01**: 通过在域名的 DNS 记录中添加一个特定的 TXT 记录来验证域名所有权. 通过域名解析该 TXT 记录, 证明你对域名的控制权.

其中方式一无法绕过备案验证, 因为其需要使用未加密的 http 以域名形式访问文件. 方式二可以绕过备案验证, 因为其只需要修改 DNS 记录, 无需使用 http 协议, 这种方式需要操作 DNS 解析记录, 手动操作不便, 使用 API 操作需要一点点技术门槛, API 的 KEY 的授权设计不好可能会导致安全问题.

2. 随着业务发展, **端口复用**迟早也会成为问题.

如果你有多个服务, 多个服务通常使用不同的端口, 也就是不仅得记忆 IP, 还得记忆端口, **不便**加上**不便**, 更难以记忆.

通常的解决方案是使用反向代理, 通过域名访问, 代理服务器根据域名转发请求到不同的服务, 这样就可以通过域名分流, 通过同一个 443 端口访问不同的服务, 反向代理的后端配置不便记忆的 IP:PORT 等 http 服务.

有少部分服务明确的依赖固定的 443 端口, 如**nextcloud**等. 利用反向代理统一使用 443 端口, 可以方便的实现证书统一管理, 减少对端口的记忆, 并提供最基础的加密安全保障.

## 结语

备案虽然麻烦, 但长久来看, 不备案将来会有更多的麻烦, 直到有一天不备案的麻烦会超过备案的麻烦, 因此我建议大家能备早备.
