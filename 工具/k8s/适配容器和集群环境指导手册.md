# 适配容器和集群环境指导手册

<!-- TOC tocDepth:2..5 chapterDepth:2..6 -->

- [容器](#容器)
  - [Docker](#docker)
    - [推荐设置](#推荐设置)
    - [bridge](#bridge)
    - [overlay](#overlay)
    - [host](#host)
    - [macvlan](#macvlan)
  - [不同网络模式的区别](#不同网络模式的区别)
    - [bridge](#bridge)
    - [overlay](#overlay)
    - [host](#host)
    - [macvlan](#macvlan)
- [集群](#集群)
  - [Kubernetes](#kubernetes)
    - [Flannel](#flannel)
      - [兼容方案](#兼容方案)
      - [不同后端模式的区别](#不同后端模式的区别)
    - [Calico](#calico)
      - [兼容方案](#兼容方案)
- [引用](#引用)

<!-- /TOC -->

微隔离产品通过接管用户主机防火墙, 从而实现网络控制, 在实际使用中存在无法完全接管防火墙的场景, 比如 kubernetes(k8s)集群. k8s 在运行时同样希望完全的接管防火墙, 将添加的规则置于最高优先级, 并持续监控, 在规则变化时确保 k8s 的防火墙规则一直处在最高优先级, 如果有需要定制网络的需求, 建议通过 k8s 的网络插件来实现, 或在 k8s 规则之后添加新规则. 考虑到 k8s 没有设置防火墙的默认规则, 而微隔离可能会设置默认规则, 如白名单主机模式的阻断模式, 大量未明确指定允许的流量都会被拦截, 显然是一种非常严格的安全模式, 微隔离规则将让步 k8s 的防火墙规则, 将微隔离的规则添加到 k8s 规则之后, 以保证 k8s 的正常运行.

## 容器

支持容器列表

| 容器名称 | 版本    | 备注 |
| :------- | :------ | :--: |
| Docker   | 18.09.6 |      |

### Docker

我们假设您已经对 Docker 有一定的了解，如果您不熟悉 Docker，可以参考[官方文档](https://docs.docker.com/).

Docker 的网络子系统可使用驱动程序插入.默认情况下，有几个驱动程序，它们提供核心联网功能：

- **bridge**: 默认网络驱动程序.如果未指定驱动程序，则这是您正在创建的网络类型.当您的应用程序在需要通信的独立容器中运行时，通常会使用网桥网络.请参阅[网桥网络](https://docs.docker.com.zh.xy2401.com/network/bridge/) .
- **overlay**: 覆盖网络将多个 Docker 守护程序连接在一起，并使群集服务能够相互通信.您还可以使用覆盖网络来促进群集服务和独立容器之间或不同 Docker 守护程序上的两个独立容器之间的通信.这种策略消除了在这些容器之间进行操作系统级路由的需要.请参阅[叠加网络](https://docs.docker.com.zh.xy2401.com/network/overlay/) .
- **host**: 对于独立的容器，取消容器与 Docker 主机之间的网络隔离，并直接使用主机的网络. `host`仅可用于 Docker 17.06 及更高版本上的集群服务.请参阅[使用主机网络](https://docs.docker.com.zh.xy2401.com/network/host/) .
- **macvlan**: Macvlan 网络允许您为容器分配 MAC 地址，使其在网络上显示为物理设备.Docker 守护程序通过其 MAC 地址将流量路由到容器.在处理希望直接连接到物理网络而不是通过 Docker 主机的网络堆栈进行路由的旧应用程序时，使用`macvlan`驱动程序有时是最佳选择.请参阅[Macvlan 网络](https://docs.docker.com.zh.xy2401.com/network/macvlan/) .
- **none**: 对于此容器，禁用所有联网.通常与自定义网络驱动程序一起使用. `none`不适用于群集服务.请参阅[禁用容器联网](https://docs.docker.com.zh.xy2401.com/network/none/) .
- [**网络插件**](https://docs.docker.com.zh.xy2401.com/engine/extend/plugins_services/) ：您可以在 Docker 上安装和使用第三方网络插件.这些插件可从[Docker Hub](https://hub.docker.com/search?category=network&q=&type=plugin)或第三方供应商处获得.有关安装和使用给定网络插件的信息，请参阅供应商的文档.

#### 推荐设置

| 网络类型 | 推荐设置                                                                             | 说明                                                                                                             |
| :------- | :----------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------- |
| bridge   | N                                                                                    | 不需要额外设置                                                                                                   |
| overlay  | 需要开放端口, <br>TCP: **7946**, **2376**, **2377** <br>UDP: **7946**, **4789** 端口 | 可以选则两种功能白名单设置方式: <br><br> 1. 将必须的端口添加到防火墙白名单中 <br> 2. 将集群的 node ip 加入白名单 |
| host     | N                                                                                    | 不需要额外设置                                                                                                   |
| macvlan  | N                                                                                    | 不需要额外设置                                                                                                   |

#### bridge

特点:

- 默认会添加一个虚拟网桥**docker0**，容器连接到网桥上，网桥连接到宿主机的网卡上
- 手动添加**bridge**网络时, 添加虚拟网桥**br-cfcXXXXXXXXX**
- 每创建一个运行的容器，就会在主机上为容器分配一个虚拟网卡**vethXXXXXXX@if43**，容器的 IP 地址通过 DHCP 协议从宿主机的网卡上获取
- 容器内创建了一个网卡**eth0@ifXX** 形成一对 veth pair，一端连接到容器内的网卡，另一端连接到网桥上
- iptables 规则修改
  - nat: 对进出容器的流量进行 DNAT 和 SNAT
  - filter: 对容器的流量进行过滤

微隔离目前仅涉及对 **filter** 表的修改, _bridge_ 模式下的 docker 没有添加规则到 filter 表.
由于容器的流量都是通过网桥转发的, 所以容器之间的通信不会被防火墙拦截, 不需要额外的设置.

#### overlay

特点:

- 通过`-network-overlay` 指定使用 overlay 网络, overlay 是一种 docker 集群网络模式, 通过 overlay 网络连接的容器之间可以互相通信, 但是不能与宿主机通信.
- 需要使用 swarm 集群, 通过`docker swarm init` 初始化集群
- 创建新的网络, bridge:`docker_gwbridge`, overlay:`ingress`
- 创建了新的网卡, **docker_gwbridge**
- 每创建一个运行的容器, 就会在主机上为容器分配一个虚拟网卡**vethXXXXXXX@if43**, 容器的 IP 地址通过 DHCP 协议从宿主机的网卡上获取
- 路由决策由 ingress 进行, ingress 会根据容器的 IP 地址, 选择一个节点, 将容器的流量转发到该节点上的 docker_gwbridge 网卡上

集群 docker 模式下, 容器间的流量可能是跨主机的, 存在被拦截的可能.

跨主机的通信依赖以下端口:

- 需要开放 TCP: **7946**, **2376**, **2377**; UDP: **7946**, **4789** 端口, 才能让 swarm 集群正常工作.

可以选则两种功能白名单设置方式:

1. 将必须的端口添加到防火墙白名单中
2. 将集群的 node ip 加入白名单

- 最安全的做法是仅将`node_ip`:`port`加入白名单.
- 如果 node_ip 在一个 cidr 中, 并且集群间可信任, 可以直接将 cidr 加入白名单.
- 如果可能存在集群节点未受微隔离管控, 可以仅将`port`加入白名单.

#### host

特点:

- 通过`-network-host` 指定使用 host 网络, 连接到 host 网络的容器共享 Docker host 的网络栈，容器的网络配置与 host 完全一样.
- 不涉及防火墙规则修改.

#### macvlan

特点:

- 使用 macvlan 网络驱动程序为每个容器的虚拟网络接口分配 MAC 地址
- 将一块物理网卡虚拟为多块虚拟网卡, 每个虚拟网卡都有自己的 MAC 地址, 通过 MAC 地址来区分不同的虚拟网卡
- 不同主机下的容器可以通过虚拟 MAC 地址进行通信, 但要需要在同一网段内
- macvlan 通过二层转发通信, 不涉及防火墙规则修改.

### 不同网络模式的区别

#### bridge

就网络而言，桥接网络是在网段之间转发流量的链路层设备.桥可以是在主机内核中运行的硬件设备或软件设备.

就 Docker 而言，网桥网络使用软件网桥，该软件网桥允许连接到同一网桥网络的容器进行通信，同时与未连接到该网桥网络的容器隔离.Docker 网桥驱动程序会自动在主机中安装规则，以使不同网桥网络上的容器无法直接相互通信.

桥接网络适用于在**同一** Docker 守护程序主机上运行的容器.为了在不同 Docker 守护程序主机上运行的容器之间进行通信，您可以在 OS 级别管理路由，也可以使用[覆盖网络](https://docs.docker.com.zh.xy2401.com/network/overlay/) .

当您启动 Docker 时，会自动创建一个[默认的网桥网络](https://docs.docker.com.zh.xy2401.com/network/bridge/#use-the-default-bridge-network) （也称为`bridge` ），除非另有说明，否则新启动的容器将连接到该网络.您还可以创建用户定义的自定义网桥网络.**用户定义的网桥网络优于默认`bridge`网络.**

#### overlay

`overlay`网络驱动程序会在多个 Docker 守护程序主机之间创建一个分布式网络.该网络位于特定于主机的网络之上（（覆盖）特定网络），从而允许与其连接的容器（包括群集服务容器）进行安全通信.Docker 透明地处理每个数据包与正确的 Docker 守护程序主机和正确的目标容器之间的路由.

初始化群集或将 Docker 主机加入现有群集时，将在该 Docker 主机上创建两个新网络：

- 一个称为`ingress`的覆盖网络，用于处理与群服务相关的控制和数据流量.创建群集服务并且不将其连接到用户定义的覆盖网络时，默认情况下它将连接到`ingress`网络.
- 一个名为`docker_gwbridge`的网桥网络，该网络将各个 Docker 守护程序连接到参与`docker_gwbridge`的其他守护程序.

您可以使用`docker network create`创建用户定义的`overlay`网络，就像创建用户定义的`bridge`网络一样.服务或容器可以一次连接到多个网络.服务或容器只能在它们各自连接的网络之间进行通信.

尽管您可以将群集服务和独立容器都连接到覆盖网络，但是默认行为和配置问题有所不同.因此，本主题的其余部分分为适用于所有覆盖网络的操作，适用于群集服务网络的操作以及适用于独立容器使用的覆盖网络的操作.

**先决条件** ：

- 使用覆盖网络的 Docker 守护程序的防火墙规则

  您需要打开以下端口，以往返于参与覆盖网络的每个 Docker 主机的流量：

  - 用于群集管理通信的 TCP 端口 2377
  - TCP 和 UDP 端口 7946，用于节点之间的通信
  - UDP 端口 4789，用于覆盖网络流量

- 之前，你可以创建一个覆盖网络，你需要或者初始化码头工人守护进程使用群经理`docker swarm init`或将其加入到现有的群`docker swarm join` .这两种方法均会创建默认的`ingress`覆盖网络，默认情况下，群集服务会使用该网络.即使您从未计划使用群体服务，也需要这样做.之后，您可以创建其他用户定义的覆盖网络.

#### host

如果将`host`网络模式用于容器，则该容器的网络堆栈不会与 Docker 主机隔离（该容器共享主机的网络名称空间），并且该容器不会分配自己的 IP 地址.例如，如果您运行一个绑定到端口 80 的容器，并且使用`host`网络，则该容器的应用程序在主机 IP 地址的端口 80 上可用.

主机模式网络对于优化性能以及在容器需要处理大量端口的情况下很有用，因为它不需要网络地址转换（NAT），并且不会为每个端口创建"userland-proxy".

#### macvlan

某些应用程序，尤其是旧版应用程序或监视网络流量的应用程序，期望直接连接到物理网络.在这种情况下，可以使用`macvlan`网络驱动程序为每个容器的虚拟网络接口分配 MAC 地址，使其看起来`macvlan`直接连接到物理网络的物理网络接口.在这种情况下，你需要指定你的 docker 主机使用的一个物理接口`macvlan` ，还有的子网和网关`macvlan` .您甚至可以使用不同的物理网络接口隔离您的`macvlan`网络.请记住以下几点：

- 由于 IP 地址耗尽或" VLAN 传播"，很容易无意间损坏您的网络，在这种情况下，您的网络中有大量不正确的唯一 MAC 地址.
- 您的网络设备需要能够处理"混杂模式"(promiscuous mode)，在该模式下，可以为一个物理接口分配多个 MAC 地址.
- 如果您的应用程序可以使用网桥（在单个 Docker 主机上）或覆盖（跨多个 Docker 主机进行通信）工作，那么从长远来看，这些解决方案可能会更好.

前提条件

- macvlan 网络驱动程序仅适用于 Linux 主机
- 至少需要 3.9 版的 Linux 内核，并建议使用 4.0 版或更高版本
- 大多数云提供商阻止 macvlan 网络.您可能需要物理访问网络设备
- 网卡需要开启混杂模式, 网卡需要能够接收所有经过它的数据流，而不论其目的地址是否是它

## 集群

支持集群列表

| 集群名称        | 版本 | 说明 |
| --------------- | ---- | ---- |
| Kubernetes(k8s) | -    | N    |

### Kubernetes

支持网络插件列表

| 插件名称 | 版本 | 说明 |
| -------- | ---- | ---- |
| Flannel  | -    | N    |
| Calico   | -    | N    |

k8s 的网路管理是通过 CNI 插件来实现的，本指导仅针对较流行的两种插件[Flannel](https://github.com/flannel-io/flannel#deploying-flannel-manually)和[Calico](https://docs.projectcalico.org/latest/introduction/)提供微隔离兼容方案.

微隔离基本拦截逻辑如下:

- 微隔离支持白名单和黑名单规则, 其中黑名单规则优先级高于白名单, 黑白名单冲突的情况下, 最终结果以黑名单为准. 未配置任何规则的情况下, 默认所有流量放行.
- 白名单存在三种防护状态, 监控/告警/阻断, 仅阻断状态下, 会产生流量拦截行为.
- 同时, 白名单有两种模式, 主机模式和服务模式.
  - 主机模式下对白名单策略以外的所有流量进行拦截,
  - 服务模式下, 当端口配置了策略时, 策略规则外的 IP 被拦截; 端口未配置策略时, 默认放行该端口的所有流量.

**为避免影响业务, 建议客户在使用白名单阻断状态时, 优先选择服务模式, 允许未知端口的流量通过.**

如果倾向使用主机模式, 请确保白名单策略已经覆盖了所有业务流量, k8s 正常工作至少需要为以下协议和端口配置防火墙规则:

**主节点**(Control plane)

| 协议 | 方向    | 端口      | 用途                    | 使用方               | 备注 |
| ---- | ------- | --------- | ----------------------- | -------------------- | ---- |
| TCP  | Inbound | 6443      | Kubernetes API server   | All                  | -    |
| TCP  | Inbound | 2379,2380 | etcd server client API  | kube-apiserver, etcd | -    |
| TCP  | Inbound | 10250     | Kubelet API             | Self, Control plane  | -    |
| TCP  | Inbound | 10259     | kube-scheduler          | Self                 | -    |
| TCP  | Inbound | 10257     | kube-controller-manager | Self                 | -    |

**工作节点**

| 协议 | 方向    | 端口        | 用途              | 使用方              | 备注                                                                      |
| ---- | ------- | ----------- | ----------------- | ------------------- | ------------------------------------------------------------------------- |
| TCP  | Inbound | 10250       | Kubelet API       | Self, Control plane | -                                                                         |
| TCP  | Inbound | 30000-32767 | NodePort Services | All                 | 随机服务端口是一个范围, 这仅是 k8s 的默认配置, 端口范围可以定制, 可选配置 |

#### Flannel

Flannel 是一个简单的网络插件，它为每个主机分配一个子网，然后在每个主机上运行一个代理，该代理负责将网络包路由到正确的目标主机.它使用 UDP 封装数据包，因此它不需要额外的配置来处理 NAT.

Flannel 可以使用多种功能的后端, 设置好后不能在运行时进行更改.

- `vxlan` 官方推荐使用, 也是实际使用场景中较多使用的.
- `hostgw` 需要二层直连能力, 通常云环境不支持.
- `udp` 当内核版本比较低，不支持 vxlan 和 host-gw 模式的时候，可以使用 UDP 模式.
- `ipip` 模式, IPIP 类型的隧道是最简单的一种.它的开销最低，但只能封装 IPv4 单播流量.
- `WireGuard` 在内核中使用 WireGuard 来封装和加密数据包.

##### 兼容方案

- 使用`vxlan`后端时, 需要确保**udp**端口**8472**是开放的.
- 使用`udp`后端时, 需要确保**udp**端口**8285**是开放的.
- 使用`wireguard`后端时, 需要确保**udp**端口**51820**是开放的, ipv6 端口**51821**也需要开放.
- `host-gw` 后端模式不需要额外的端口开放.
- 确保您的防火墙规则允许所有参与覆盖网络的主机使用此流量
- 确保允许 pod 访问 master

**我们需要确认 Flannel 使用了何种 backend.**

##### 不同后端模式的区别

| 后端      | 原理                                                                                                                                                                                                                                                                                                                                                                        |
| --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| vxlan     | 在 Underlay 网络之上使用 vxlan 网卡把普通 IP 数据封装在 UDP 包中然后穿透 Underlay 层网络从而实现 L2/L3 层的网络包互通.                                                                                                                                                                                                                                                      |
| host-gw   | 在 host 主机上配置 Overlay 的 subnet 对端 host 的路由信息，数据包没有经过任何封装而直接送往对端，这要求 Host 在同一个二层网络中.                                                                                                                                                                                                                                            |
| udp       | 为 host 创建一个 tun 的设备，tun 设备是一个虚拟网路设备，通常一端连接着 kernel 网络协议栈，而另一端就取决于网络设备驱动的实现，一般连接着应用进程，网络数据包发送到这个 tun 设备上后从管道的出口到达应用程序，这个时候应用程序可以根据需求对数据包进行拆包和解包再回传给 eth0 或其他网络设备，从而到达隧道的另一端.flannel 的 udp 模式 tun 设备连接的另一端是 flanneld 进程 |
| ipip      | 报文的基础上再封装成一个 IPv4 报文, 只能封装 IPv4 单播流量，因此您将无法设置 OSPF、RIP 或任何其他基于多播的协议                                                                                                                                                                                                                                                             |
| wrirguard | 使用 WireGuard 来封装和加密数据包.                                                                                                                                                                                                                                                                                                                                          |

#### Calico

##### 兼容方案

## 引用

- [Docker 网络概述](https://dockerdocs.cn/network/)
- [联网和网络策略](https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/addons/#networking-and-network-policy)
