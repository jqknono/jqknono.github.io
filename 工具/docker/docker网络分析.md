---
layout: page
title: docker网络分析
published: true
date: 2023-04-21 18:25:47
categories: 工具
tags: 工具, docker
---

<!-- TOC tocDepth:2..3 chapterDepth:2..6 -->

- [网络种类](#网络种类)
- [bridge 模式](#bridge-模式)
  - [DOCKER 链](#docker-链)
  - [DOCKER-ISOLATION 链](#docker-isolation-链)
  - [DOCKER-USER 链](#docker-user-链)
- [overlay 网络](#overlay-网络)
  - [Swarm mode](#swarm-mode)
- [host 网络](#host-网络)
- [Macvlan 网络](#macvlan-网络)
- [docker compose](#docker-compose)
- [总结](#总结)
- [参考](#参考)

<!-- /TOC -->

## 网络种类

- bridge 模式：容器使用 docker0 网桥，容器的网络配置与主机不一致
- host 模式：容器使用主机的网络，容器的网络配置与主机一致
- none 模式：容器不使用任何网络，容器的网络配置与主机不一致
- container 模式：容器使用另一个容器的网络，容器的网络配置与主机不一致

## bridge 模式

bridge 模式是 docker 默认的网络模式，容器使用 docker0 网桥，容器的网络配置与主机不一致

在 bridge 模式下，

- 连在同一网桥上的容器可以相互通信
- 容器与宿主机之间可以相互通信

![picture 1](https://s2.loli.net/2023/05/06/hq1BOj5wWQP2pJz.png)

分析 iptables 规则

```bash
root@ubuntu:~/docker_network# iptables-save
# Generated by iptables-save v1.8.4 on Mon Feb 20 01:38:46 2023
*filter
:INPUT ACCEPT [3929:300293]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [3850:319123]
:DOCKER - [0:0]
:DOCKER-ISOLATION-STAGE-1 - [0:0]
:DOCKER-ISOLATION-STAGE-2 - [0:0]
:DOCKER-USER - [0:0]
-A FORWARD -j DOCKER-USER
-A FORWARD -j DOCKER-ISOLATION-STAGE-1
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -o docker0 -j DOCKER
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT
-A FORWARD -o br-499528c9fcf3 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -o br-499528c9fcf3 -j DOCKER
-A FORWARD -i br-499528c9fcf3 ! -o br-499528c9fcf3 -j ACCEPT
-A FORWARD -i br-499528c9fcf3 -o br-499528c9fcf3 -j ACCEPT
-A DOCKER -d 172.17.0.2/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 80 -j ACCEPT
-A DOCKER -d 172.17.0.3/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 80 -j ACCEPT
-A DOCKER -d 172.17.0.4/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 80 -j ACCEPT
-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2
-A DOCKER-ISOLATION-STAGE-1 -i br-499528c9fcf3 ! -o br-499528c9fcf3 -j DOCKER-ISOLATION-STAGE-2
-A DOCKER-ISOLATION-STAGE-1 -j RETURN
-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP
-A DOCKER-ISOLATION-STAGE-2 -o br-499528c9fcf3 -j DROP
-A DOCKER-ISOLATION-STAGE-2 -j RETURN
-A DOCKER-USER -j RETURN
COMMIT
# Completed on Mon Feb 20 01:38:46 2023
# Generated by iptables-save v1.8.4 on Mon Feb 20 01:38:46 2023
*nat
:PREROUTING ACCEPT [1:242]
:INPUT ACCEPT [1:242]
:OUTPUT ACCEPT [33:3027]
:POSTROUTING ACCEPT [33:3027]
:DOCKER - [0:0]
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
-A POSTROUTING -s 192.168.58.0/24 ! -o br-499528c9fcf3 -j MASQUERADE
-A POSTROUTING -s 172.17.0.2/32 -d 172.17.0.2/32 -p tcp -m tcp --dport 80 -j MASQUERADE
-A POSTROUTING -s 172.17.0.3/32 -d 172.17.0.3/32 -p tcp -m tcp --dport 80 -j MASQUERADE
-A POSTROUTING -s 172.17.0.4/32 -d 172.17.0.4/32 -p tcp -m tcp --dport 80 -j MASQUERADE
-A DOCKER -i docker0 -j RETURN
-A DOCKER -i br-499528c9fcf3 -j RETURN
-A DOCKER ! -i docker0 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 172.17.0.2:80
-A DOCKER ! -i docker0 -p tcp -m tcp --dport 8081 -j DNAT --to-destination 172.17.0.3:80
-A DOCKER ! -i docker0 -p tcp -m tcp --dport 8082 -j DNAT --to-destination 172.17.0.4:80
COMMIT
# Completed on Mon Feb 20 01:38:46 2023
```

- docker 安装后在防火墙添加了新的链,

  - filter
    - DOCKER
    - DOCKER-ISOLATION-STAGE-1
    - DOCKER-ISOLATION-STAGE-2
    - DOCKER-USER
  - nat
    - DOCKER

- 每创建一个运行的容器, 都会创建一个虚拟网卡, 用于容器与宿主机的通信, 以及容器与其他容器的通信.
- 在未暴露端口提供主机到容器的映射服务前, 未添加新的防火墙规则.
- 添加端口映射后, 对防火墙添加了以下规则, 可以看到入站方向默认的服务形式是白名单形式, 仅许可的端口才能访问, 出站方向默认允许所有流量.

  - filter
    - DOCKER: `-A DOCKER -d 172.17.0.2/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 80 -j ACCEPT`
  - nat
    - DOCKER(NAT): `-A DOCKER ! -i docker0 -p tcp -m tcp --dport 49155 -j DNAT --to-destination 172.17.0.2:80`
    - POSTROUTING(SNAT): `-A POSTROUTING -s 172.17.0.2/32 -d 172.17.0.2/32 -p tcp -m tcp --dport 80 -j MASQUERADE`

**Docker 在 iptables 的 filter 表中的链**

在 2015.12 之前，Docker 只额外提供了 DOCKER 链。

在此之后，直到 Docker 17.06.0(2017.6)之前的版本中，Docker 提供了如下 2 个链:

- DOCKER
- DOCKER-ISOLATION

在 Docker 17.06.0(2017.6)及之后，Docker 18.03.1(2018.4)及之前的版本中，Docker 提供了如下 3 个链:

- DOCKER
- DOCKER-ISOLATION
- DOCKER-USER

查看 Docker 的 iptables 如下：

```
Chain FORWARD (policy ACCEPT)
target     prot opt source               destination
DOCKER-USER  all  --  0.0.0.0/0            0.0.0.0/0
DOCKER-ISOLATION-STAGE-1  all  --  0.0.0.0/0            0.0.0.0/0
DOCKER     all  --  0.0.0.0/0            0.0.0.0/0
```

在 Docker 18.05.0(2018.5)及之后的版本中，提供如下 4 个 chain:

- DOCKER
- DOCKER-ISOLATION-STAGE-1
- DOCKER-ISOLATION-STAGE-2
- DOCKER-USER

目前，Docker 默认对宿主机的 iptables 设置规则完整一览：

```
-A FORWARD -j DOCKER-USER
-A FORWARD -j DOCKER-ISOLATION-STAGE-1
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -o docker0 -j DOCKER
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT
-A FORWARD -o br-499528c9fcf3 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -o br-499528c9fcf3 -j DOCKER
-A FORWARD -i br-499528c9fcf3 ! -o br-499528c9fcf3 -j ACCEPT
-A FORWARD -i br-499528c9fcf3 -o br-499528c9fcf3 -j ACCEPT
-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2
-A DOCKER-ISOLATION-STAGE-1 -i br-499528c9fcf3 ! -o br-499528c9fcf3 -j DOCKER-ISOLATION-STAGE-2
-A DOCKER-ISOLATION-STAGE-1 -j RETURN
-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP
-A DOCKER-ISOLATION-STAGE-2 -o br-499528c9fcf3 -j DROP
-A DOCKER-ISOLATION-STAGE-2 -j RETURN
-A DOCKER-USER -j RETURN
```

### DOCKER 链

仅处理从宿主机到 docker0 的 IP 数据包。

### DOCKER-ISOLATION 链

- 为了隔离在**不同的 bridge 网络**之间的容器，Docker 提供了两个 DOCKER-ISOLATION 阶段实现。
- DOCKER-ISOLATION-STAGE-1 链过滤**源地址是 bridge 网络**(默认 docker0)的 IP 数据包，匹配的 IP 数据包再进入 DOCKER-ISOLATION-STAGE-2 链处理，不匹配就返回到父链 FORWARD。
- 在 DOCKER-ISOLATION-STAGE-2 链中，进一步处理**目的地址是 bridge 网络**的 IP 数据包，匹配的 IP 数据包表示该 IP 数据包是从一个 bridge 网络的网桥发出，到另一个 bridge 网络的网桥，这样的 IP 数据包来自其他 bridge 网络，将被直接 DROP；不匹配的 IP 数据包就返回到父链 FORWARD 继续进行后续处理。

### DOCKER-USER 链

Docker 启动时，会加载 DOCKER 链和 DOCKER-ISOLATION 链中的过滤规则，并使之生效。绝对禁止修改这里的过滤规则。

如果用户要补充 Docker 的过滤规则，强烈建议追加到 DOCKER-USER 链。DOCKER-USER 链中的过滤规则，将先于 Docker 默认创建的规则被加载，从而能够覆盖 Docker 在 DOCKER 链和 DOCKER-ISOLATION 链中的默认过滤规则。

## overlay 网络

使用`docker network create -d overlay my-overlay` 创建 overlay 网络前, 需要使用`swam mode`.

`overlay`网络驱动程序会在多个 Docker 守护程序主机之间创建一个分布式网络。该网络位于特定于主机的网络之上覆盖特定网络，从而允许与其连接的容器(包括群集服务容器)进行安全通信。Docker 透明地处理每个数据包与正确的 Docker 守护程序主机和正确的目标容器之间的路由。

初始化群集或将 Docker 主机加入现有群集时，将在该 Docker 主机上创建两个新网络：

- 一个称为`ingress`的 overlay 网络，用于处理与群服务相关的控制和数据流量。创建群集服务并且不将其连接到用户定义的 overlay 网络时，默认情况下它将连接到`ingress`网络。
- 一个名为`docker_gwbridge`的网桥网络，该网络将各个 Docker 守护程序连接到参与`docker_gwbridge`的其他守护程序。

先决条件 ：

- 使用 overlay 网络的 Docker 守护程序的防火墙规则, 您需要打开以下端口，以往返于参与 overlay 网络的每个 Docker 主机的流量：
  - 用于群集管理通信的 TCP 端口 2377
  - TCP 和 UDP 端口 7946，用于节点之间的通信
  - UDP 端口 4789，用于 overlay 网络流量
- 创建一个 overlay 网络，你需要或者初始化码头工人守护进程使用群管理 docker swarm init 或将其加入到现有的群 docker swarm join 。这两种方法均会创建默认的 ingress overlay 网络，默认情况下，群集服务会使用该网络。即使您从未计划使用集群服务，也需要这样做。之后，您可以创建自定义的 overlay 网络。

### Swarm mode

Docker Swarm 是管理跨节点容器的编排工具，相较于 Docker Compose 而言，Compose 只能编排单节点上的容器，Swarm 将一群 Docker 节点虚拟化为一个主机，使得用户只要在单一主机上操作就能完成对整个容器集群的管理工作。如果下载的是最新版的 Docker，那么 Swarm 就已经被包含在内了，无需再安装。

Docker Swarm 架构包含两种角色，manager 和 node，前者是 Swarm Daemon 工作的节点，包含了调度器、路由、服务发现等功能，负责接收客户端的集群管理请求，然后调度 Node 进行具体的容器工作，比如容器的创建、扩容与销毁等。 manager 本身也是一个 node。

要在群集中使用入口网络，在启用群集模式之前，需要在群集节点之间打开以下端口：

- 用于容器网络发现的端口 7946 TCP / UDP。
- 容器入口网络的端口 4789 UDP。
- TCP 2376 用于群集管理通信。
- TCP 2377 用于群集管理通信。

![picture 2](https://s2.loli.net/2023/05/06/HEJW1dvKnMrNOQl.png)  
![picture 3](https://s2.loli.net/2023/05/06/TxNUYgtPZqHEV2d.png)  
![picture 4](https://s2.loli.net/2023/05/06/9jWVzQgRkA38pGY.png)  
![picture 5](https://s2.loli.net/2023/05/06/m2q9WIkGDw1Jxv7.png)

路由决策

![picture 6](https://s2.loli.net/2023/05/06/wrYKbVoQ8svtAhW.png)

## host 网络

如果将 host 网络模式用于容器，则该容器的网络堆栈不会与 Docker 主机隔离（该容器共享主机的网络名称空间），并且该容器不会分配自己的 IP 地址。例如，如果您运行一个绑定到端口 80 的容器，并且使用 host 网络，则该容器的应用程序在主机 IP 地址的端口 80 上可用。

主机模式网络对于优化性能以及在容器需要处理大量端口的情况下很有用，因为它不需要网络地址转换（NAT），并且不会为每个端口创建“ userland-proxy”。

主机网络驱动程序仅在 Linux 主机上工作，而 Mac 的 Docker 桌面，Windows 的 Docker 桌面或 Windows Server 的 Docker EE 不支持该主机网络驱动程序。通过将--network host 传递给--network host docker service create 命令，您还可以将 host 网络用于群集服务。在这种情况下，控制流量（与管理群集和服务有关的流量）仍会通过覆盖网络发送，但是单个群集服务容器会使用 Docker 守护程序的主机网络和端口发送数据。这带来了一些额外的限制。例如，如果服务容器绑定到端口 80，则在给定的群集节点上只能运行一个服务容器。

直接运行, `docker run --name test1 --rm -d --network host nginx`, 以使用 host 网络.
没有新增防火墙规则.

## Macvlan 网络

某些应用程序，尤其是旧版应用程序或监视网络流量的应用程序，期望直接连接到物理网络。在这种情况下，可以使用 macvlan 网络驱动程序为每个容器的虚拟网络接口分配 MAC 地址，使其看起来 macvlan 直接连接到物理网络的物理网络接口。在这种情况下，你需要指定你的 docker 主机使用的一个物理接口 macvlan ，还有的子网和网关 macvlan 。您甚至可以使用不同的物理网络接口隔离您的 macvlan 网络。请记住以下几点：

- 由于 IP 地址耗尽或“ VLAN 传播”，很容易无意间损坏您的网络，在这种情况下，您的网络中有大量不正确的唯一 MAC 地址。
- 您的网络设备需要能够处理“混杂模式”，在该模式下，可以为一个物理接口分配多个 MAC 地址。
- 如果您的应用程序可以使用 bridge（在单个 Docker 主机上）或 overlay（跨多个 Docker 主机进行通信）工作，那么从长远来看，这些解决方案可能会更好。

## docker compose

配置:

- `network_mode`, 同 `docker run --network`
  - bridge
  - host
  - none
  - service:[service name]
  - container:[container name/id]

## 总结

各网络类型特点

| 网络类型 | 网卡修改 | 防火墙修改 | 特征                                                                                                                                                                               | 备注                                                             |
| -------- | -------- | ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- |
| bridge   | 是       | 是         | filter: <br> - DOCKER <br> - DOCKER-USER <br> - DOCKER-ISOLATION-STAGE-1 <br> - DOCKER-ISOLATION-STAGE-2; <br> - DOCKER-ISOLATION(old) <br> nat: <br> - DOCKER                     | 1. 默认网络类型 <br> 2. 子网 bridge <br> 3. DOCKER-USER 优先加载 |
| overlay  | 是       | 是         | nat: <br> - DOCKER <br> - DOCKER-INGRESS <br> - DOCKER-OVERLAY <br> <br> port:<br> TCP port 2377 集群管理 <br> TCP and UDP port 7946 node 通信 <br> UDP port 4789 overlay 网络流量 | 1. 跨主机网络 <br> 2. 子网 overlay                               |
| host     | 否       | 否         | 无                                                                                                                                                                                 | 1. 容器共享主机网络 <br> 2. 无子网                               |
| Macvlan  | 是       | 否         | 无                                                                                                                                                                                 | 1. 分配多个 mac 接入虚拟 lan                                     |

- bridge 模式, 在白名单阻断模式下
  - 需要开放 docker 子网网段, 默认使用的子网网段是 172.17.0.1/16
- swarm 模式
  - 需要开放 TCP: 7946, 2376, 2377; UDP: 4789 端口, 才能让 swarm 集群正常工作.
  - 集群的 node ip 间需要加白名单
  - docker_gwbridge 网段需要加白名单 172.18.0.1/16

示例:

![picture 7](https://s2.loli.net/2023/05/06/dcw6YL8qj3GDR2J.png)  
![picture 8](https://s2.loli.net/2023/05/06/Nua8IL7JCxT4y96.png)

## 参考

- [基于 iptables 的 Docker 网络隔离与通信详解](https://blog.csdn.net/taiyangdao/article/details/88844558)
- [云原生之 Docker Swarm 服务编排介绍及使用入门](https://bbs.huaweicloud.com/blogs/354452)
- [【Docker 系列】Swarm 的 ingress 网络](https://blog.csdn.net/weixin_48447848/article/details/122678297)
- [Docker-Swarm](https://www.lixin.help/2021/07/24/Docker-Swarm.html)
- [Docker 网络与防火墙](https://www.jianshu.com/p/3144be82b187)
- [使用主机网络](https://docs.docker.com.zh.xy2401.com/network/host/)
- [Docker repo](https://github.com/moby/moby)
- [Docker：网络模式详解](https://outmanzzq.github.io/2019/10/22/docker-network/)
